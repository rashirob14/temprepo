name: RDP (Ubuntu - XFCE + Tailscale)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    env:
      # avoid printing this in logs; it's written to GITHUB_ENV later
      RDP_USER: RDP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic packages & update
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget curl gnupg2 ca-certificates ubuntu-desktop-minimal \
            xfce4 xfce4-goodies xrdp dbus-x11 policykit-1 \
            net-tools lsb-release jq openssl procps

      - name: Configure XFCE for xrdp
        run: |
          set -euo pipefail
          # Ensure Xfce session is default for xrdp
          # Backup existing startwm.sh
          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak || true
          # Replace startwm.sh to start xfce4-session
          echo '#!/bin/sh' | sudo tee /etc/xrdp/startwm.sh >/dev/null
          echo 'unset DBUS_SESSION_BUS_ADDRESS' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          echo 'unset XDG_RUNTIME_DIR' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          echo 'exec startxfce4' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          sudo chmod +x /etc/xrdp/startwm.sh

          # Enable and restart xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          # Give xrdp a moment
          sleep 2
          sudo systemctl status xrdp --no-pager || true

      - name: Create RDP user with secure password (saved to GITHUB_ENV only)
        id: make_user
        run: |
          set -euo pipefail
          USERNAME="${RDP_USER:-RDP}"

          # Generate a strong password (24 bytes base64 -> ~32 chars)
          PASSWORD=$(openssl rand -base64 24)

          # Create user if not exists
          if id "$USERNAME" >/dev/null 2>&1; then
            echo "User $USERNAME already exists"
            # Optionally reset password
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          # Avoid expiration
          sudo chage -I -1 -m 0 -M 99999 -E -1 "$USERNAME"

          # Write credentials to GITHUB_ENV (this file is not echoed to logs by Actions)
          echo "RDP_CREDS_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_CREDS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # Confirm creation silently (no password printed)
          if ! id "$USERNAME" >/dev/null 2>&1; then
            echo "User creation failed" >&2
            exit 1
          fi

      - name: Install Tailscale (official installer - robust across distros)
        run: |
          set -euo pipefail
          # Official Tailscale installer auto-detects distro/codename
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale (use secret auth key)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "Missing TAILSCALE_AUTH_KEY secret" >&2
            exit 1
          fi
          HOSTNAME="gh-runner-${GITHUB_RUN_ID:-manual}"
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${HOSTNAME}" || {
            echo "tailscale up failed" >&2
            sudo tailscale status || true
            exit 1
          }

          # Wait for an IPv4 address
          TS_IP=""
          for i in $(seq 1 12); do
            TS_IP=$(tailscale ip -4 2>/dev/null || true)
            if [ -n "$TS_IP" ]; then break; fi
            sleep 3
          done

          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Dumping status for debugging:" >&2
            sudo tailscale status || true
            exit 1
          fi

          # Export to GITHUB_ENV for later steps (safe)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=$HOSTNAME" >> $GITHUB_ENV

      - name: (Optional) Configure firewall to allow XRDP (port 3389)
        run: |
          set -euo pipefail
          # Do not enable UFW if it may block needed services in your environment.
          # This step ensures port 3389 is allowed locally.
          if command -v ufw >/dev/null 2>&1; then
            sudo ufw --force enable || true
            sudo ufw allow 3389/tcp || true
            sudo ufw reload || true
          else
            echo "ufw not present or not usable; ensure port 3389 is open where required."
          fi

      - name: Verify connectivity to XRDP on Tailscale IP
        run: |
          set -euo pipefail
          TS_IP="${{ env.TAILSCALE_IP }}"
          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IP found in env" >&2
            exit 1
          fi
          echo "Checking TCP connectivity to $TS_IP:3389"
          # Install netcat if missing
          if ! command -v nc >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y netcat
          fi
          if nc -z -w 5 "$TS_IP" 3389; then
            echo "TCP connectivity to $TS_IP:3389 OK"
          else
            echo "TCP connection to RDP port 3389 failed" >&2
            sudo systemctl status xrdp --no-pager || true
            sudo tailscale status || true
            exit 1
          fi

      - name: Print safe connection info (DOES NOT print password)
        run: |
          set -euo pipefail
          echo "=== RDP CONNECT INFO ==="
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "Tailscale Hostname: ${{ env.TAILSCALE_HOSTNAME }}"
          echo "Username: ${{ env.RDP_CREDS_USER }}"
          echo ""
          echo "Password has been written to GITHUB Actions environment file (GITHUB_ENV)."
          echo "To retrieve it: open the workflow run -> Actions -> click the run -> go to 'Variables' or use the runner to read from the environment."
          echo ""
          echo "IMPORTANT: Avoid leaking the password in public logs. The job does not print it here."
          echo "========================"

      - name: Maintain Connection (keep job alive; heartbeat)
        run: |
          set -euo pipefail
          echo "Keeping workflow active. Stop run to terminate."
          while true; do
            echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] RDP active - heartbeat (sleep 300s)"
            sleep 300
          done
