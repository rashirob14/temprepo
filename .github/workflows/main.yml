name: RDP (Ubuntu)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout (needed for some runners)
        uses: actions/checkout@v4

      - name: Update & install prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xrdp policykit-1 wget curl gnupg2 ca-certificates \
            ufw jq openssl

      - name: Configure XRDP and core settings
        run: |
          set -euo pipefail
          # Ensure xrdp service is enabled and restarted
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Allow xrdp user sessions in /etc/ssl/limits (Ubuntu default usually fine)
          # Make sure a desktop session is available (depends on runner image).
          # If desktop environment is missing, xrdp will still install but may not provide a GUI.

          # Open firewall port 3389 (TCP) for testing - Tailscale will restrict access by default,
          # but keep port open locally so xrdp can bind.
          sudo ufw --force enable
          sudo ufw allow 3389/tcp
          sudo ufw reload

      - name: Create RDP user with secure password
        env:
          GITHUB_ENV: ${{ github.env }}
        run: |
          set -euo pipefail
          # Generate a strong 16+ character password with high entropy
          PASSWORD=$(openssl rand -base64 24)
          USERNAME="RDP"

          # Create user if not exists (non-interactive)
          if id "$USERNAME" >/dev/null 2>&1; then
              echo "User $USERNAME already exists"
          else
              sudo useradd -m -s /bin/bash "$USERNAME"
              echo "$USERNAME:$PASSWORD" | sudo chpasswd
              sudo usermod -aG sudo "$USERNAME"
          fi

          # Ensure user has no password expiry
          sudo chage -I -1 -m 0 -M 99999 -E -1 "$USERNAME"

          # Add credentials to environment for later steps (GITHUB_ENV)
          echo "RDP_CREDS=User: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # Quick check
          if ! id "$USERNAME" >/dev/null 2>&1; then
              echo "User creation failed" >&2
              exit 1
          fi

      - name: Install Tailscale (official repo)
        run: |
          set -euo pipefail
          # Official Tailscale install for Debian/Ubuntu
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale.list | \
            sed 's#deb https://pkgs.tailscale.com/stable/ubuntu focal main#deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu focal main#' \
            | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Establish Tailscale connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "Missing TAILSCALE_AUTH_KEY secret" >&2
            exit 1
          fi

          HOSTNAME="gh-runner-${GITHUB_RUN_ID:-manual}"
          # Bring up tailscale using auth key and set hostname
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${HOSTNAME}" || {
            echo "tailscale up failed" >&2
            sudo tailscale status || true
            exit 1
          }

          # Wait for IPv4 address to appear (retry)
          TS_IP=""
          for i in {1..12}; do
            TS_IP=$(tailscale ip -4 || true)
            if [ -n "$TS_IP" ]; then break; fi
            sleep 5
          done

          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Dumping status:" >&2
            tailscale status || true
            exit 1
          fi

          # Export to environment for later steps
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=$HOSTNAME" >> $GITHUB_ENV
          echo "tailscale IP: $TS_IP"

      - name: Verify RDP / XRDP accessibility over Tailscale
        run: |
          set -euo pipefail
          TS_IP=${{ env.TAILSCALE_IP }}
          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IP found in env" >&2
            exit 1
          fi

          echo "Testing TCP connectivity to $TS_IP:3389"
          # Use netcat if available; otherwise install
          if ! command -v nc >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y netcat
          fi

          if ! nc -z -w 5 "$TS_IP" 3389; then
            echo "TCP connection to RDP port 3389 failed (from runner)." >&2
            echo "Check xrdp service and firewall settings."
            sudo systemctl status xrdp --no-pager || true
            exit 1
          fi

          echo "TCP connectivity successful!"

      - name: Print connection info (keeps secret in GITHUB_ENV)
        run: |
          set -euo pipefail
          echo "=== RDP ACCESS ==="
          echo "Address: ${{ env.TAILSCALE_IP }}"
          echo "Hostname: ${{ env.TAILSCALE_HOSTNAME }}"
          echo "Username: ${{ env.RDP_USER }}"
          # Do NOT print password to logs in plain text; the password is available in GITHUB_ENV if needed.
          echo "Password stored in GITHUB_ACTIONS environment variable RDP_PASSWORD (GITHUB_ENV)."
          echo "=================="

      - name: Maintain Connection (keep job alive)
        run: |
          set -euo pipefail
          echo "Keeping workflow active. Press Ctrl+C to cancel workflow run."
          # Print periodic heartbeat to logs so user can see it's alive
          while true; do
            echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] RDP Active - sleeping 300s"
            sleep 300
          done
