name: RDP (Ubuntu - XFCE + Tailscale) — host or Kali container

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode: 'host' to configure the runner, 'kali' to start a Kali container with XFCE+xrdp"
        required: false
        default: "host"
      keep_alive:
        description: "Keep the runner alive after setup ('true'/'false')"
        required: false
        default: "true"

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    env:
      RDP_USER: RDP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare variables
        id: prep
        env:
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_KEEP_ALIVE: ${{ github.event.inputs.keep_alive }}
          SECRET_KALI_PASS: ${{ secrets.KALI_RDP_PASSWORD }}
        run: |
          set -euo pipefail
          MODE="${INPUT_MODE:-host}"
          KEEP_ALIVE="${INPUT_KEEP_ALIVE:-true}"
          echo "MODE=${MODE}" >> $GITHUB_ENV
          echo "KEEP_ALIVE=${KEEP_ALIVE}" >> $GITHUB_ENV
          # Kali credentials: prefer secret KALI_RDP_PASSWORD if set, otherwise default to 'root' (insecure)
          if [ -n "${SECRET_KALI_PASS:-}" ]; then
            echo "KALI_RDP_PASSWORD=${SECRET_KALI_PASS}" >> $GITHUB_ENV
          else
            echo "KALI_RDP_PASSWORD=root" >> $GITHUB_ENV
          fi
          echo "KALI_RDP_USER=Kali" >> $GITHUB_ENV

      - name: Install common packages (host)
        if: ${{ github.event.inputs.mode == 'host' }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget curl gnupg2 ca-certificates ubuntu-desktop-minimal \
            xfce4 xfce4-goodies xrdp dbus-x11 policykit-1 \
            net-tools lsb-release jq openssl procps

      - name: Configure XFCE for xrdp (host)
        if: ${{ github.event.inputs.mode == 'host' }}
        run: |
          set -euo pipefail
          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak || true
          # avoid a here-doc (can sometimes upset YAML parsers); use printf -> sudo tee
          printf '%s\n' '#!/bin/sh' 'unset DBUS_SESSION_BUS_ADDRESS' 'unset XDG_RUNTIME_DIR' 'exec startxfce4' | sudo tee /etc/xrdp/startwm.sh >/dev/null
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sleep 2
          sudo systemctl status xrdp --no-pager || true

      - name: Create RDP user (host)
        if: ${{ github.event.inputs.mode == 'host' }}
        id: make_user
        run: |
          set -euo pipefail
          USERNAME="${RDP_USER:-RDP}"
          PASSWORD=$(openssl rand -base64 24)
          if id "$USERNAME" >/dev/null 2>&1; then
            echo "User $USERNAME already exists"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi
          sudo chage -I -1 -m 0 -M 99999 -E -1 "$USERNAME"
          echo "RDP_CREDS_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_CREDS_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          if ! id "$USERNAME" >/dev/null 2>&1; then
            echo "User creation failed" >&2
            exit 1
          fi

      - name: Ensure Docker available (kali)
        if: ${{ github.event.inputs.mode == 'kali' }}
        run: |
          set -euo pipefail
          # GitHub-hosted runners normally have docker; verify
          if ! command -v docker >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y docker.io
          fi
          docker --version

      - name: Start Kali container with XFCE + xrdp (kali)
        if: ${{ github.event.inputs.mode == 'kali' }}
        run: |
          set -euo pipefail
          CT_NAME="kali-rdp"
          docker rm -f "$CT_NAME" >/dev/null 2>&1 || true
          docker pull kalilinux/kali-rolling:latest
          docker run -d --name "$CT_NAME" --network host --privileged --cap-add=NET_ADMIN \
            kalilinux/kali-rolling:latest sleep infinity
          docker exec -i "$CT_NAME" bash -lc "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends xfce4 xfce4-goodies xrdp sudo"
          docker exec -i "$CT_NAME" bash -lc "id -u ${KALI_RDP_USER} >/dev/null 2>&1 || useradd -m -s /bin/bash ${KALI_RDP_USER}"
          printf '%s:%s\n' "${KALI_RDP_USER}" "${KALI_RDP_PASSWORD}" | docker exec -i "$CT_NAME" chpasswd
          docker exec -i "$CT_NAME" bash -lc "usermod -aG sudo ${KALI_RDP_USER} || true"
          docker exec -i "$CT_NAME" bash -lc "mkdir -p /home/${KALI_RDP_USER}/.xsession && echo 'startxfce4' > /home/${KALI_RDP_USER}/.xsession && chown ${KALI_RDP_USER}:${KALI_RDP_USER} /home/${KALI_RDP_USER}/.xsession"
          docker exec -i "$CT_NAME" bash -lc "nohup /usr/sbin/xrdp-sesman >/var/log/xrdp-sesman.log 2>&1 &"
          docker exec -i "$CT_NAME" bash -lc "nohup /usr/sbin/xrdp >/var/log/xrdp.log 2>&1 &"
          echo "RDP_CREDS_USER=${KALI_RDP_USER}" >> $GITHUB_ENV
          echo "RDP_CREDS_PASSWORD=${KALI_RDP_PASSWORD}" >> $GITHUB_ENV

      - name: Install Tailscale (optional/common)
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale (optional — secret)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "WARNING: TAILSCALE_AUTH_KEY not provided; skipping Tailscale setup" >&2
            echo "SKIP_TAILSCALE=1" >> $GITHUB_ENV
            echo "TAILSCALE_IP=" >> $GITHUB_ENV
            echo "TAILSCALE_HOSTNAME=" >> $GITHUB_ENV
            exit 0
          fi
          HOSTNAME="gh-runner-${GITHUB_RUN_ID:-manual}"
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${HOSTNAME}" || { echo "tailscale up failed" >&2; sudo tailscale status || true; exit 1; }
          TS_IP=""
          for i in $(seq 1 12); do
            TS_IP=$(tailscale ip -4 2>/dev/null || true)
            if [ -n "$TS_IP" ]; then break; fi
            sleep 3
          done
          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Dumping status:" >&2
            sudo tailscale status || true
            exit 1
          fi
          echo "TAILSCALE_IP=${TS_IP}" >> $GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=${HOSTNAME}" >> $GITHUB_ENV
          echo "SKIP_TAILSCALE=0" >> $GITHUB_ENV

      - name: Optional: allow XRDP port on firewall (host)
        if: ${{ github.event.inputs.mode == 'host' }}
        run: |
          set -euo pipefail
          if command -v ufw >/dev/null 2>&1; then
            sudo ufw --force enable || true
            sudo ufw allow 3389/tcp || true
            sudo ufw reload || true
          else
            echo "ufw not present; ensure port 3389 is reachable where required."
          fi

      - name: Debug: show listeners and tailscale status
        run: |
          set -euo pipefail
          echo "--- xrdp listener (ss) ---"
          ss -ltnp 2>/dev/null | grep ':3389' || echo 'no listener on :3389 found'
          echo "--- lsof for 3389 ---"
          sudo lsof -nP -iTCP:3389 -sTCP:LISTEN || true
          if command -v tailscale >/dev/null 2>&1; then
            echo "--- tailscale ip -4 ---"
            sudo tailscale ip -4 || true
            echo "--- tailscale status ---"
            sudo tailscale status || true
          fi
          echo "--- host IPv4 addresses ---"
          ip -4 addr show scope global

      - name: Print safe connection info
        run: |
          set -euo pipefail
          echo "=== RDP CONNECT INFO ==="
          if [ "${SKIP_TAILSCALE:-0}" = "1" ]; then
            echo "Tailscale was not configured for this run."
            echo "To enable: add secret TAILSCALE_AUTH_KEY in repo Settings -> Secrets and re-run."
          else
            echo "Tailscale IP: ${TAILSCALE_IP:-<not-set>}"
            echo "Tailscale Hostname: ${TAILSCALE_HOSTNAME:-<not-set>}"
            echo ""
            echo "Connect: <TAILSCALE_IP>:3389 using the username/password below"
          fi
          echo ""
          echo "Username: ${RDP_CREDS_USER:-${KALI_RDP_USER}}"
          echo "Password: stored in GITHUB Actions environment file (GITHUB_ENV) for this run."
          echo "If SKIP_TAILSCALE=1 and you used 'kali' mode on GitHub-hosted runners, the container uses --network host and is NOT publicly reachable."
          echo "========================"

      - name: Keep-alive or finish
        run: |
          set -euo pipefail
          if [ "${KEEP_ALIVE:-true}" != "true" ]; then
            echo "KEEP_ALIVE is false — finishing job."
            exit 0
          fi
          echo "Keeping workflow active. Stop run to terminate."
          while true; do
            echo "[$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")] heartbeat (sleep 300s)"
            sleep 300
          done
