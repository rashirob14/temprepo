name: RDP (Ubuntu - XFCE + Tailscale)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    env:
      # avoid printing this in logs; it's written to GITHUB_ENV later
      RDP_USER: RDP

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic packages & update
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget curl gnupg2 ca-certificates ubuntu-desktop-minimal \
            xfce4 xfce4-goodies xrdp dbus-x11 policykit-1 \
            net-tools lsb-release jq openssl procps

      - name: Configure XFCE for xrdp
        run: |
          set -euo pipefail
          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak || true
          echo '#!/bin/sh' | sudo tee /etc/xrdp/startwm.sh >/dev/null
          echo 'unset DBUS_SESSION_BUS_ADDRESS' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          echo 'unset XDG_RUNTIME_DIR' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          echo 'exec startxfce4' | sudo tee -a /etc/xrdp/startwm.sh >/dev/null
          sudo chmod +x /etc/xrdp/startwm.sh

          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sleep 2
          sudo systemctl status xrdp --no-pager || true

      - name: Create RDP user with secure password (saved to GITHUB_ENV only)
        id: make_user
        run: |
          set -euo pipefail
          USERNAME="${RDP_USER:-RDP}"

          # Generate a strong password (24 bytes base64 -> ~32 chars)
          PASSWORD=$(openssl rand -base64 24)

          if id "$USERNAME" >/dev/null 2>&1; then
            echo "User $USERNAME already exists"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          sudo chage -I -1 -m 0 -M 99999 -E -1 "$USERNAME"

          # Write credentials to GITHUB_ENV (not echoed in logs)
          echo "RDP_CREDS_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_CREDS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          if ! id "$USERNAME" >/dev/null 2>&1; then
            echo "User creation failed" >&2
            exit 1
          fi

      - name: Install Tailscale (official installer - robust across distros)
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale (use secret auth key if provided)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euo pipefail

          # If TAILSCALE_AUTH_KEY is not provided, skip tailscale setup
          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "WARNING: TAILSCALE_AUTH_KEY not provided; skipping Tailscale setup" >&2
            echo "SKIP_TAILSCALE=1" >> $GITHUB_ENV
            echo "TAILSCALE_IP=" >> $GITHUB_ENV
            echo "TAILSCALE_HOSTNAME=" >> $GITHUB_ENV
            exit 0
          fi

          HOSTNAME="gh-runner-${GITHUB_RUN_ID:-manual}"
          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${HOSTNAME}" || {
            echo "tailscale up failed" >&2
            sudo tailscale status || true
            exit 1
          }

          # Wait for an IPv4 address
          TS_IP=""
          for i in $(seq 1 12); do
            TS_IP=$(tailscale ip -4 2>/dev/null || true)
            if [ -n "$TS_IP" ]; then break; fi
            sleep 3
          done

          if [ -z "$TS_IP" ]; then
            echo "Tailscale IP not assigned. Dumping status for debugging:" >&2
            sudo tailscale status || true
            exit 1
          fi

          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "TAILSCALE_HOSTNAME=$HOSTNAME" >> $GITHUB_ENV
          echo "SKIP_TAILSCALE=0" >> $GITHUB_ENV

      - name: (Optional) Configure firewall to allow XRDP (port 3389)
        run: |
          set -euo pipefail
          if command -v ufw >/dev/null 2>&1; then
            sudo ufw --force enable || true
            sudo ufw allow 3389/tcp || true
            sudo ufw reload || true
          else
            echo "ufw not present or not usable; ensure port 3389 is open where required."
          fi

      - name: Verify connectivity to XRDP on Tailscale IP
        run: |
          set -euo pipefail
          if [ "${SKIP_TAILSCALE:-0}" = "1" ]; then
            echo "Skipping XRDP/Tailscale connectivity check because SKIP_TAILSCALE=1"
            exit 0
          fi

          TS_IP="${TAILSCALE_IP:-}"
          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IP found in env" >&2
            exit 1
          fi
          echo "Checking TCP connectivity to $TS_IP:3389"
          if ! command -v nc >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y netcat
          fi
          if nc -z -w 5 "$TS_IP" 3389; then
            echo "TCP connectivity to $TS_IP:3389 OK"
          else
            echo "TCP connection to RDP port 3389 failed" >&2
            sudo systemctl status xrdp --no-pager || true
            sudo tailscale status || true
            exit 1
          fi

      - name: Print safe connection info (DOES NOT print password)
        run: |
          set -euo pipefail
          echo "=== RDP CONNECT INFO ==="
          if [ "${SKIP_TAILSCALE:-0}" = "1" ]; then
            echo "Tailscale was not configured for this run."
            echo "To enable, add the secret TAILSCALE_AUTH_KEY in: Settings -> Secrets and variables -> Actions"
          else
            echo "Tailscale IP: ${TAILSCALE_IP}"
            echo "Tailscale Hostname: ${TAILSCALE_HOSTNAME}"
          fi
          echo "Username: ${RDP_CREDS_USER}"
          echo ""
          echo "Password has been written to GITHUB Actions environment file (GITHUB_ENV)."
          echo "Avoid leaking the password in public logs."
          echo "========================"

      - name: Maintain Connection (keep job alive; heartbeat)
        run: |
          set -euo pipefail
          echo "Keeping workflow active. Stop run to terminate."
          while true; do
            echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] RDP active - heartbeat (sleep 300s)"
            sleep 300
          done
