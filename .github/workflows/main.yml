# Add this file to create a Kali container with XFCE + xrdp and a Kali user (password 'root').
#
# WARNING: using password 'root' is insecure. Prefer storing the password in
# a repository secret (e.g. secrets.KALI_RDP_PASSWORD) and using that in the workflow.
on:
  workflow_dispatch:

jobs:
  kali-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600
    env:
      RDP_USER: Kali
      RDP_PASSWORD: root   # replace with ${{ secrets.KALI_RDP_PASSWORD }} for safety
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Docker is available
        run: |
          set -euo pipefail
          # GitHub hosted runners already have Docker; confirm it's working
          docker --version

      - name: Pull Kali image
        run: |
          set -euo pipefail
          docker pull kalilinux/kali-rolling

      - name: Run Kali container and install XFCE + xrdp
        run: |
          set -euo pipefail
          # Container name
          CT_NAME="kali-rdp"
          # Remove any existing container with same name
          docker rm -f "$CT_NAME" >/dev/null 2>&1 || true

          # Run a privileged/host-networked container so xrdp listens on host network
          # Host networking makes the container's 3389 reachable on the runner's network stack.
          docker run -d --name "$CT_NAME" --network host --privileged --cap-add=NET_ADMIN \
            kalilinux/kali-rolling:latest sleep infinity

          # Install packages inside the running container
          docker exec -i "$CT_NAME" bash -lc "apt-get update && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends xfce4 xfce4-goodies xrdp sudo && \
            systemctl disable --now snapd || true || true"

          # Create user and set password (Kali / root per your request)
          docker exec -i "$CT_NAME" bash -lc "id -u ${RDP_USER} >/dev/null 2>&1 || useradd -m -s /bin/bash ${RDP_USER}"
          # Set password (note: chpasswd expects input 'user:password')
          printf '%s:%s\n' "${RDP_USER}" "${RDP_PASSWORD}" | docker exec -i "$CT_NAME" chpasswd

          # Allow the user sudo (optional)
          docker exec -i "$CT_NAME" bash -lc "usermod -aG sudo ${RDP_USER} || true"

          # Ensure xrdp uses XFCE
          docker exec -i "$CT_NAME" bash -lc "mkdir -p /home/${RDP_USER}/.xsession; echo 'startxfce4' > /home/${RDP_USER}/.xsession; chown ${RDP_USER}:${RDP_USER} /home/${RDP_USER}/.xsession"

          # Start xrdp inside the container (systemd is not running; use xrdp-sesman + xrdp directly)
          docker exec -i "$CT_NAME" bash -lc "nohup /usr/sbin/xrdp-sesman >/var/log/xrdp-sesman.log 2>&1 &"
          docker exec -i "$CT_NAME" bash -lc "nohup /usr/sbin/xrdp >/var/log/xrdp.log 2>&1 &"

          # Write credentials to GITHUB environment (not echoed to logs)
          echo "KALI_RDP_USER=${RDP_USER}" >> $GITHUB_ENV
          echo "KALI_RDP_PASSWORD=${RDP_PASSWORD}" >> $GITHUB_ENV

          # Confirm xrdp is listening on port 3389 on the host network
          ss -ltnp 2>/dev/null | grep -E ':3389\s' || true

      - name: Print connection info (do not print password)
        run: |
          set -euo pipefail
          echo "Kali container started and xrdp was attempted to be started inside it."
          echo "Username: ${KALI_RDP_USER:-Kali}"
          echo "Password: stored in GITHUB Actions environment file (GITHUB_ENV)."
          echo "If you configured Tailscale on the runner, connect to the runner's Tailscale IP on port 3389."
          echo ""
          echo "To see the runner's IPs and xrdp status, view the run logs or inspect the container on the runner."

      - name: Keep the job alive (so you can connect)
        run: |
          set -euo pipefail
          echo "Keeping workflow active. Stop run to terminate."
          while true; do
            sleep 300
          done
